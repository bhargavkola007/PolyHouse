<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ğŸŒ¡ï¸ Polyhouse Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="viewdata.css">

  <style>
    #modeToggleBtn {
      padding: 8px 16px;
      font-weight: 600;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-left: 10px;
    }
  </style>
</head>

<body>

<header>
  <h1>ğŸŒ¡ï¸ Polyhouse Temperature Controller</h1>
  <button onclick="window.location.href='visualization.html'">ğŸ“Š View Chart</button>
  <button id="modeToggleBtn">Mode: AUTO</button>
</header>

<main class="container">
  <div class="sensor-grid">

    <!-- Temperature -->
    <!-- RELAY 1 -->
<div class="sensor-card" data-sensor="relay1">
  <h2>ğŸ”¥ Temperature Relay</h2>

  <div class="temp-display">
    <span id="waterTemp">--</span> Â°C
  </div>

  <p>Status: <span class="status">--</span></p>

  <div class="btn-group">
    <button class="on-btn">ON</button>
    <button class="off-btn">OFF</button>
  </div>

  <p>ğŸ•’ <span id="ts">--</span></p>
</div>

    <!-- Fan -->
    <div class="sensor-card" data-sensor="relay2">
      <h2>ğŸŒ€ Cooling Fan</h2>
      <p>Status: <span class="status">--</span></p>
      <div class="btn-group">
        <button class="on-btn">ON</button>
        <button class="off-btn">OFF</button>
      </div>
    </div>

    <!-- Sprinkler -->
    <div class="sensor-card" data-sensor="relay3">
      <h2>ğŸ’¦ Sprinkler</h2>
      <p>Status: <span class="status">--</span></p>
      <div class="btn-group">
        <button class="on-btn">ON</button>
        <button class="off-btn">OFF</button>
      </div>
    </div>

  </div>
</main>

<footer>
  Â© 2025 Centurion University | IoT Polyhouse Monitoring
</footer>

<script>
/* ===================== CONFIG ===================== */
const API_ROOT =
  window.location.hostname === "localhost"
    ? "http://localhost:8080/sensors"
    : "https://polyhouse-qqiy.onrender.com/sensors";

/* ===================== MODE ===================== */
async function syncMode() {
  const res = await fetch(`${API_ROOT}/control/relay2`);
  const d = await res.json();
  updateModeButton(d.mode || "AUTO");
}

async function toggleAutoManual() {
  const res = await fetch(`${API_ROOT}/control/relay2`);
  const d = await res.json();

  const newMode = d.mode === "AUTO" ? "MANUAL" : "AUTO";

  for (const relay of ["relay2", "relay3"]) {
    const payload =
      newMode === "MANUAL"
        ? { mode: "MANUAL", state: "OFF" }   // âœ… REQUIRED
        : { mode: "AUTO" };

    await fetch(`${API_ROOT}/control/${relay}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
  }

  updateModeButton(newMode);
}

function updateModeButton(mode) {
  const btn = document.getElementById("modeToggleBtn");
  btn.innerText = `Mode: ${mode}`;
  btn.style.background = mode === "AUTO" ? "#16a34a" : "#dc2626";
  btn.style.color = "#fff";
}

/* ===================== TEMPERATURE ===================== */
async function loadLatest() {
  const res = await fetch(`${API_ROOT}/latest`);
  if (!res.ok) return;
  const d = await res.json();
  document.getElementById("waterTemp").textContent = d.waterTemperature ?? "--";
  document.getElementById("ts").textContent = d.timestamp ?? "--";
}

/* ===================== RELAY STATE ===================== */
async function loadRelay(sensor) {
  const res = await fetch(`${API_ROOT}/control/${sensor}`);
  if (!res.ok) return;
  const d = await res.json();
  updateRelayUI(sensor, d.state, d.mode);
}

function updateRelayUI(sensor, state, mode) {
  const card = document.querySelector(`.sensor-card[data-sensor="${sensor}"]`);
  if (!card) return;

  const status = card.querySelector(".status");
  const onBtn = card.querySelector(".on-btn");
  const offBtn = card.querySelector(".off-btn");

  status.textContent = state;
  status.style.color = state === "ON" ? "#00c853" : "#d32f2f";

  if (mode === "AUTO") {
    onBtn.disabled = true;
    offBtn.disabled = true;
  } else {
    onBtn.disabled = state === "ON";
    offBtn.disabled = state === "OFF";
  }
}

/* ===================== MANUAL CONTROL ===================== */
async function controlRelay(sensor, state) {
  const res = await fetch(`${API_ROOT}/control/${sensor}`);
  const d = await res.json();
  if (d.mode === "AUTO") {
    alert("Switch to MANUAL mode first!");
    return;
  }

  await fetch(`${API_ROOT}/control/${sensor}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ state, mode: "MANUAL" })
  });

  loadRelay(sensor);
}

/* ===================== EVENTS ===================== */
document.getElementById("modeToggleBtn")
  .addEventListener("click", toggleAutoManual);

document.querySelectorAll(".sensor-card").forEach(card => {
  const sensor = card.dataset.sensor;
  card.querySelector(".on-btn")?.addEventListener("click", () => controlRelay(sensor, "ON"));
  card.querySelector(".off-btn")?.addEventListener("click", () => controlRelay(sensor, "OFF"));
});

/* ===================== INIT ===================== */
syncMode();
loadLatest();
["relay1","relay2","relay3"].forEach(loadRelay);

setInterval(loadLatest, 5000);
setInterval(() => ["relay2","relay3"].forEach(loadRelay), 7000);
</script>

</body>
</html>