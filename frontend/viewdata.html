<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ğŸŒ¡ï¸ Polyhouse Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="viewdata.css">

  <style>
    #modeToggleBtn {
      padding: 8px 16px;
      font-weight: 600;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-left: 10px;
    }
  </style>
</head>

<body>

<header>
  <h1>ğŸŒ¡ï¸ Polyhouse Temperature Controller</h1>
  <button onclick="window.location.href='visualization.html'">ğŸ“Š View Chart</button>
  <button id="modeToggleBtn">Mode: AUTO</button>
</header>

<main class="container">

  <!-- TOP TEMPERATURE DASHBOARD -->
  <section class="temperature-section">
    <div class="temp-card">
      <h2>ğŸŒ¡ï¸ Current Temperature</h2>
      <div class="temp-value">
        <span id="waterTemp">--</span>Â°C
      </div>
      <p class="timestamp">Last updated: <span id="ts">--</span></p>
    </div>
  </section>

  <!-- RELAYS SECTION -->
  <section class="relay-section">
    <h2 class="section-title">âš™ï¸ Control Relays</h2>

    <div class="sensor-grid">

      <!-- RELAY 1 -->
      <div class="sensor-card" data-sensor="relay1">
        <h3>ğŸ”¥ Heater (Manual)</h3>
        <p>Status: <span class="status">--</span></p>
        <div class="btn-group">
          <button class="on-btn">ON</button>
          <button class="off-btn">OFF</button>
        </div>
      </div>

      <!-- RELAY 2 -->
      <div class="sensor-card" data-sensor="relay2">
        <h3>ğŸŒ€ Cooling Fan</h3>
        <p>Status: <span class="status">--</span></p>
        <div class="btn-group">
          <button class="on-btn">ON</button>
          <button class="off-btn">OFF</button>
        </div>
      </div>

      <!-- RELAY 3 -->
      <div class="sensor-card" data-sensor="relay3">
        <h3>ğŸ’¦ Sprinkler</h3>
        <p>Status: <span class="status">--</span></p>
        <div class="btn-group">
          <button class="on-btn">ON</button>
          <button class="off-btn">OFF</button>
        </div>
      </div>

    </div>
  </section>

</main>

<footer>
  Â© 2025 Centurion University | IoT Polyhouse Monitoring
</footer>

<script>
/* ===================== CONFIG ===================== */
const API_ROOT =
  window.location.hostname === "localhost"
    ? "http://localhost:8080/sensors"
    : "https://polyhouse-qqiy.onrender.com/sensors";

let systemMode = "AUTO"; // derived from relay2

/* ===================== MODE ===================== */
async function syncMode() {
  const res = await fetch(`${API_ROOT}/control/relay2`);
  const d = await res.json();
  systemMode = d.mode || "AUTO";
  updateModeButton(systemMode);
}

async function toggleAutoManual() {
  const newMode = systemMode === "AUTO" ? "MANUAL" : "AUTO";

  for (const relay of ["relay2", "relay3"]) {
    const payload =
      newMode === "MANUAL"
        ? { mode: "MANUAL", state: "OFF" }
        : { mode: "AUTO" };

    await fetch(`${API_ROOT}/control/${relay}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
  }

  systemMode = newMode;
  updateModeButton(systemMode);
}

function updateModeButton(mode) {
  const btn = document.getElementById("modeToggleBtn");
  btn.innerText = `Mode: ${mode}`;
  btn.style.background = mode === "AUTO" ? "#16a34a" : "#dc2626";
  btn.style.color = "#fff";
}

/* ===================== TEMPERATURE ===================== */
async function loadLatest() {
  const res = await fetch(`${API_ROOT}/latest`);
  if (!res.ok) return;
  const d = await res.json();
  document.getElementById("waterTemp").textContent = d.waterTemperature ?? "--";
  document.getElementById("ts").textContent = d.timestamp ?? "--";
}

/* ===================== RELAY STATE ===================== */
async function loadRelay(sensor) {
  const res = await fetch(`${API_ROOT}/control/${sensor}`);
  if (!res.ok) return;
  const d = await res.json();
  updateRelayUI(sensor, d.state);
}

function updateRelayUI(sensor, state) {
  const card = document.querySelector(`.sensor-card[data-sensor="${sensor}"]`);
  if (!card) return;

  const status = card.querySelector(".status");
  const onBtn = card.querySelector(".on-btn");
  const offBtn = card.querySelector(".off-btn");

  status.textContent = state;
  status.style.color = state === "ON" ? "#00c853" : "#d32f2f";

  // relay1 = always manual
  if (sensor === "relay1") {
    onBtn.disabled = false;
    offBtn.disabled = false;
    return;
  }

  // relay2 & relay3
  if (systemMode === "AUTO") {
    onBtn.disabled = true;
    offBtn.disabled = true;
  } else {
    onBtn.disabled = state === "ON";
    offBtn.disabled = state === "OFF";
  }
}

/* ===================== MANUAL CONTROL ===================== */
async function controlRelay(sensor, state) {
  if (sensor !== "relay1" && systemMode === "AUTO") {
    alert("Switch to MANUAL mode first!");
    return;
  }

  await fetch(`${API_ROOT}/control/${sensor}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ state, mode: "MANUAL" })
  });

  loadRelay(sensor);
}

/* ===================== EVENTS ===================== */
document.getElementById("modeToggleBtn")
  .addEventListener("click", toggleAutoManual);

document.querySelectorAll(".sensor-card").forEach(card => {
  const sensor = card.dataset.sensor;
  card.querySelector(".on-btn").addEventListener("click", () => controlRelay(sensor, "ON"));
  card.querySelector(".off-btn").addEventListener("click", () => controlRelay(sensor, "OFF"));
});

/* ===================== INIT ===================== */
syncMode();
loadLatest();
["relay1","relay2","relay3"].forEach(loadRelay);

setInterval(loadLatest, 5000);
setInterval(() => ["relay1","relay2","relay3"].forEach(loadRelay), 7000);
</script>

</body>
</html>