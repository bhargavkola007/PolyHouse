<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ğŸŒ¡ï¸ Temperature Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <h1>ğŸŒ¡ï¸ Polyhouse Temperature Controller</h1>
    <button class="nav-btn" onclick="window.location.href='visualization.html'">ğŸ“Š View Chart</button>
  </header>

  <main class="container">
    <div class="sensor-card">
      <h2>Water Temperature</h2>
      <div class="temp-display">
        <span id="waterTemp">--</span><span class="unit">Â°C</span>
      </div>

      <div class="btn-group">
        <button class="on-btn" onclick="controlSensor('waterTemp','ON')">Turn ON</button>
        <button class="off-btn" onclick="controlSensor('waterTemp','OFF')">Turn OFF</button>
      </div>

      <p class="timestamp">ğŸ•’ Last Updated: <span id="ts">--</span></p>
    </div>
  </main>

  <footer>
    <p>Â© 2025 Centurion University | IoT Polyhouse Monitoring</p>
  </footer>

 <script>
const API_ROOT =
  window.location.hostname === "localhost"
    ? "http://localhost:8080/sensors"
    : "https://polyhouse-qqiy.onrender.com/sensors";

// ğŸŸ¢ Load latest temperature
async function loadLatest() {
  try {
    const res = await fetch(`${API_ROOT}/latest`);
    if (res.ok) {
      const d = await res.json();
      document.getElementById("waterTemp").textContent = d.waterTemperature ?? "--";
      document.getElementById("ts").textContent = d.timestamp ?? "--";
    }
  } catch (err) {
    console.error("âŒ Error fetching temperature:", err);
  }
}

// ğŸŸ¢ Load relay state from backend
async function loadSensorState(sensor) {
  try {
    const res = await fetch(`${API_ROOT}/control/${sensor}`);
    if (res.ok) {
      const d = await res.json();
      updateSensorStateUI(sensor, d.state);
    }
  } catch (err) {
    console.error("âŒ Error fetching sensor state:", err);
  }
}

// ğŸŸ¢ Update UI appearance and button states
function updateSensorStateUI(sensor, state) {
  const card = document.querySelector(".sensor-card");
  const onBtn = document.querySelector(".on-btn");
  const offBtn = document.querySelector(".off-btn");
  const statusLabel = document.getElementById("statusLabel");

  card.classList.toggle("on", state === "ON");
  card.classList.toggle("off", state === "OFF");

  onBtn.disabled = state === "ON";
  offBtn.disabled = state === "OFF";

  statusLabel.textContent = state;
  statusLabel.style.color = state === "ON" ? "#00c853" : "#d32f2f";
}

// ğŸŸ¢ Handle ON/OFF control
async function controlSensor(sensor, state) {
  const onBtn = document.querySelector(".on-btn");
  const offBtn = document.querySelector(".off-btn");

  // Disable both while processing
  onBtn.disabled = true;
  offBtn.disabled = true;

  try {
    const res = await fetch(`${API_ROOT}/control/${sensor}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ state })
    });

    if (res.ok) {
      const result = await res.json();
      alert(result.message);
      updateSensorStateUI(sensor, state);
    } else {
      alert("âš ï¸ Failed to change sensor state.");
    }
  } catch (err) {
    console.error("âŒ Control error:", err);
    alert("Error communicating with device.");
  } finally {
    // Re-enable buttons after 2 seconds
    setTimeout(() => {
      onBtn.disabled = false;
      offBtn.disabled = false;
    }, 2000);
  }
}

// ğŸŸ¢ Initial load
loadLatest();
loadSensorState("waterTemp");

// ğŸŸ¢ Periodic refresh
setInterval(loadLatest, 5000);
setInterval(() => loadSensorState("waterTemp"), 7000);
</script>

</body>
</html>
