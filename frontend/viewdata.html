<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>ğŸŒ¡ï¸ Polyhouse Controller</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- External CSS -->
  <link rel="stylesheet" href="viewdata.css">
</head>

<body>

<!-- ================= HEADER ================= -->
<header>
  <h1>ğŸŒ¿ Polyhouse Temperature Controller</h1>

  <div class="header-buttons">

    <!-- Back Button -->
    <button class="back-btn" onclick="window.history.back()">â¬… Back</button>

    <!-- Chart Button -->
    <button class="chart-btn" onclick="window.location.href='visualization.html'">
      ğŸ“Š View Chart
    </button>

    <!-- Mode Toggle -->
    <button id="modeToggleBtn" class="mode-btn auto-mode">
      Mode: AUTO
    </button>
  </div>
</header>

<!-- ================= MAIN ================= -->
<main class="container">

  <!-- Temperature Card -->
  <section class="temperature-section">
    <div class="temp-card">
      <h2>ğŸŒ¡ï¸ Current Temperature</h2>

      <div class="temp-value">
        <span id="waterTemp">--</span>Â°C
      </div>

      <p class="timestamp">
        Last Updated: <span id="ts">--</span>
      </p>
    </div>
  </section>

  <!-- Relay Section -->
  <section class="relay-section">
    <h2 class="section-title">âš™ï¸ Relay Controls</h2>

    <div class="sensor-grid">

      <!-- Relay 1 -->
      <div class="sensor-card" data-sensor="relay1">
        <h3>ğŸ”¥ Heater (Manual)</h3>
        <p>Status: <span class="status">--</span></p>

        <div class="btn-group">
          <button class="on-btn">ON</button>
          <button class="off-btn">OFF</button>
        </div>
      </div>

      <!-- Relay 2 -->
      <div class="sensor-card" data-sensor="relay2">
        <h3>ğŸŒ€ Cooling Fan</h3>
        <p>Status: <span class="status">--</span></p>

        <div class="btn-group">
          <button class="on-btn">ON</button>
          <button class="off-btn">OFF</button>
        </div>
      </div>

      <!-- Relay 3 -->
      <div class="sensor-card" data-sensor="relay3">
        <h3>ğŸ’¦ Sprinkler</h3>
        <p>Status: <span class="status">--</span></p>

        <div class="btn-group">
          <button class="on-btn">ON</button>
          <button class="off-btn">OFF</button>
        </div>
      </div>

    </div>
  </section>

</main>

<!-- ================= FOOTER ================= -->
<footer>
  Â© 2025 Centurion University | IoT Polyhouse Monitoring System
</footer>

<!-- ================= SCRIPT ================= -->
<script>
/* ================= CONFIG ================= */
const API_ROOT =
  window.location.hostname === "localhost"
    ? "http://localhost:8080/sensors"
    : "https://polyhouse-qqiy.onrender.com/sensors";

let systemMode = "AUTO";

/* ================= MODE ================= */
async function syncMode() {
  const res = await fetch(`${API_ROOT}/control/relay2`);
  const d = await res.json();
  systemMode = d.mode || "AUTO";
  updateModeButton(systemMode);
}

async function toggleAutoManual() {
  const newMode = systemMode === "AUTO" ? "MANUAL" : "AUTO";

  for (const relay of ["relay2", "relay3"]) {
    const payload =
      newMode === "MANUAL"
        ? { mode: "MANUAL", state: "OFF" }
        : { mode: "AUTO" };

    await fetch(`${API_ROOT}/control/${relay}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });
  }

  systemMode = newMode;
  updateModeButton(systemMode);
}

function updateModeButton(mode) {
  const btn = document.getElementById("modeToggleBtn");

  btn.innerText = `Mode: ${mode}`;
  btn.className = mode === "AUTO"
    ? "mode-btn auto-mode"
    : "mode-btn manual-mode";
}

/* ================= TEMPERATURE ================= */
async function loadLatest() {
  const res = await fetch(`${API_ROOT}/latest`);
  if (!res.ok) return;
  const d = await res.json();

  document.getElementById("waterTemp").textContent =
    d.waterTemperature ?? "--";

  document.getElementById("ts").textContent =
    d.timestamp ?? "--";
}

/* ================= RELAY STATE ================= */
async function loadRelay(sensor) {
  const res = await fetch(`${API_ROOT}/control/${sensor}`);
  if (!res.ok) return;
  const d = await res.json();
  updateRelayUI(sensor, d.state);
}

function updateRelayUI(sensor, state) {
  const card = document.querySelector(
    `.sensor-card[data-sensor="${sensor}"]`
  );

  const status = card.querySelector(".status");
  const onBtn = card.querySelector(".on-btn");
  const offBtn = card.querySelector(".off-btn");

  status.textContent = state;

  card.classList.remove("on", "off");
  card.classList.add(state === "ON" ? "on" : "off");

  if (sensor === "relay1") return;

  if (systemMode === "AUTO") {
    onBtn.disabled = true;
    offBtn.disabled = true;
  } else {
    onBtn.disabled = state === "ON";
    offBtn.disabled = state === "OFF";
  }
}

/* ================= MANUAL CONTROL ================= */
async function controlRelay(sensor, state) {
  if (sensor !== "relay1" && systemMode === "AUTO") {
    alert("âš  Switch to MANUAL mode first!");
    return;
  }

  await fetch(`${API_ROOT}/control/${sensor}`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ state, mode: "MANUAL" })
  });

  loadRelay(sensor);
}

/* ================= EVENTS ================= */
document.getElementById("modeToggleBtn")
  .addEventListener("click", toggleAutoManual);

document.querySelectorAll(".sensor-card").forEach(card => {
  const sensor = card.dataset.sensor;

  card.querySelector(".on-btn")
    .addEventListener("click", () => controlRelay(sensor, "ON"));

  card.querySelector(".off-btn")
    .addEventListener("click", () => controlRelay(sensor, "OFF"));
});

/* ================= INIT ================= */
syncMode();
loadLatest();
["relay1","relay2","relay3"].forEach(loadRelay);

setInterval(loadLatest, 5000);
setInterval(() => ["relay1","relay2","relay3"].forEach(loadRelay), 7000);
</script>

</body>
</html>
